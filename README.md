# **ココフォリア追加チャットパレット**

<sub>Userscript / Tampermonkey ・ by Apocrypha (a.k.a. ぬべ太郎) – MIT License</sub>

---

## ✨ これは何？

[ココフォリア] のチャットパレットを  
*ボタン・ミニスクリプト・変数* で超拡張する Tampermonkey スクリプトです。

* **ワンクリック実行** … コマンドをボタン化  
* **ミニ JavaScript** … `[ … ]` で書いた JS がその場で実行  
* **式・変数展開** … `:HP-{DMG}` / `DMG += 1` のように動的操作  
* **インテリセンス** … CodeMirror 上で `Ctrl-Space / Tab` 完全補完  
* **キャラクターボックス API** … `CharBox()` 系に加え  
  `CharBoxNumber()` で **ボックス順を名前検索**  
* **設定エクスポート** … `.ccp` へワンクリック保存・共有

---

## 🖥️ インストール

1. ブラウザに **Tampermonkey** を導入  
2. このリポジトリの **`Userscript.user.js`** を **Raw** で開き → **Install**  
3. ココフォリアを開くと右上（ダイスバー横）に **📄** アイコンが出れば成功

> **アップデート**  
> スクリプト内の `@version` が変わると Tampermonkey が自動更新し  
> ページリロード確認ダイアログを表示します。

---

## ⌨️ ホットキー

| キー           | 動作                       |
|----------------|---------------------------|
| **Alt ＋ P**   | パレット表示 / 非表示     |
| **Alt ＋ O**   | コマンド編集ウィンドウ     |
| **Alt ＋ V**   | 変数編集ウィンドウ         |
| **A**          | Auto スクリプト（開発中） |

---

## 📐 ウィンドウ操作

| 操作                     | 内容                                           |
|--------------------------|------------------------------------------------|
| **ドラッグ**             | タイトルバーを掴んで移動（座標は自動保存）    |
| **右下 ↘︎ つまみ**        | 自由にリサイズ                                |
| **⤓ / ⤒ ボタン**         | `.ccp` へエクスポート / 既存 `.ccp` を読込   |

> `.ccp` は JSON ベース。  
> エクスポートするとローカル設定をリセットするので共有が楽です。

---

## 📝 コマンド編集の基本

例：<br>

```js
:AP-1
[ WAIT 500 ]
CCB<=70 【パンチ】
[ if (CMessage[0].Find('S')) CMessage[0].Send('1d6 【ダメージ】'); ]
```

* 1行 = 1 コマンドボタン

* [ WAIT ms ] … ミリ秒 待機

* [ … ] … JavaScript ブロック（ミニスクリプト）

### 📚 スクリプト API 超速リファレンス

| シンボル                       | 機能 / 戻り値                  | 備考                   |         |           |
| -------------------------- | ------------------------- | -------------------- | ------- | --------- |
| **`SEnd()`**               | 以降の行を即スキップ                | –                    |         |           |
| **`Wait(ms)`**             | `ms` ミリ秒待機                | `[ WAIT ]` の JS 版    |         |           |
| **`CMessage[n]`**          | 直近 n 番目のメッセージ             | 0 = 最新               |         |           |
|   ↳ `.Find('S')`           | 成功/スペシャルを含む？(`bool`)      | `KW_ALIAS` 対応        |         |           |
|   ↳ `.GetNum()`            | “…＞ 12” ➜ `12` (`number`) | –                    |         |           |
|   ↳ `.Send(txt…)`          | 追加送信（内部でウェイト順守）           | –                    |         |           |
| **`Actor(name)`**          | アクター切替（非同期内部化）            | `Actor.Now()` で現在名取得 |         |           |
| **`CharBox(lbl, idx)`**    | **現在値** (\`number         | string               | null\`) | `'HP'` など |
| **`CharBoxMax(lbl, idx)`** | **最大値** または現在値            | –                    |         |           |
| **`CharBoxRaw(lbl, idx)`** | `"20/35"` の生文字列           | –                    |         |           |
| **`CharBoxNumber(label)`** | **キャラ名 → ボックス番号** (`int`) | 要 `LoadNames()`      |         |           |
| **`LoadNames()`**          | キャラ名キャッシュを更新              | 非同期扱いだがボタン内でも呼べる     |         |           |
> インテリセンス
> Ctrl-Space / Tab で候補ポップアップ。
> Actor. と打つと Set, Now … 等のメンバが出ます。

### 📦 変数（グローバル）
* 変数編集ウィンドウで NAME / 値 を追加

* コマンド中に {NAME}、スクリプト内では NAME として参照

* 変更は自動保存 → 次回セッションでも引き継ぎ

### スクリプトで使えるもの

> **KW_ALIAS**  
> `'S'` = 成功 / スペシャル、 `'F'` = 致命的失敗 …など。  
> `CMessage[0].Find('S')` のように使えます。

---

## 📦 エクスポート内容

```jsonc
{
  "version": 1,
  "cmds":   [ /* ボタンとコマンド配列 */ ],
  "vars":   [ /* 変数名 / 値 */ ],
  "autoCmd": [ /* Auto スクリプト */ ]
}
```

ファイル名は `追加チャット情報YYYY-MM-DDTHH-MM-SS.ccp` が初期値。  
ダイアログで好きな名前・場所に変更可。

[MIT](LICENSE)  
Copyright © Apocrypha

## ■ クレジット
* CodeMirror, marked, DOMPurify – MIT

> 本スクリプトとココフォリア運営様とは一切関係ありません。  
> 利用は自己責任でお願いします。


_（見てわかると思うんだけど普通にこのREADMEはChatGPTに適当に投げて作りました。多分正確かもしれない）_
